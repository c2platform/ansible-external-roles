---
- name: Configure conf/server.xml
  template:
    src: server.xml.j2
    dest: "{{ tomcat_home_version }}/conf/server.xml"
    mode: "0644"
    backup: yes
  notify:
    - restart tomcat instance

- name: Configure conf/tomcat-users.xml
  template:
    src: tomcat-users.xml.j2
    dest: "{{ tomcat_home_version }}/conf/tomcat-users.xml"
    mode: "0644"
    backup: yes
  notify:
    - restart tomcat instance

- name: Configure bin/setenv.sh
  template:
    src: setenv.sh.j2
    dest: "{{ tomcat_home_version }}/bin/setenv.sh"
    mode: "0644"
    backup: yes
  notify:
    - restart tomcat instance

- block:
    - set_fact:
        tomcat_git_config:
          dir:  "{{ tomcat_git_config_parent_dir }}/tomcat-git-config-{{ tomcat_git_config['repo']|hash('sha1') }}"

    - set_fact:
        tomcat_git_clone_delegate: localhost
      when: tomcat_git_config_control_node

    - name: Git checkout
      ansible.builtin.git:
        repo: "{{ tomcat_git_config['repo'] }}"
        dest: "{{ tomcat_git_config['dir'] }}"
        version: "{{ tomcat_git_config['version']|default(omit) }}"
      delegate_to: "{{ tomcat_git_clone_delegate|default(omit) }}"
      when: tomcat_git_config is defined
      changed_when: False
  when: tomcat_git_config is defined
